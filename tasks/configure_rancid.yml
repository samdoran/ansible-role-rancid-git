---
- name: Copy hosts file
  template: src=hosts.j2 dest=/etc/hosts owner=root group=root mode=0644
  tags: rancid

- name: Add rancid to git group
  user: name=rancid
        append=yes
        groups=git
  tags: rancid

- name: Change permissions on {{ rancid_home }}
  file: path={{ rancid_home }}
        owner=root
        group=rancid
        mode=0770
  tags: rancid

- name: Check if LIST_OF_GROUPS has changed
  shell: egrep '^LIST_OF_GROUPS' /etc/rancid/rancid.conf | awk -F \" '{print $2}'
  register: current_list_of_groups
  tags: rancid

- name: Copy rancid.conf
  template: src=rancid.conf.j2
            dest=/etc/rancid/rancid.conf
            owner=root
            group=rancid
            mode=0640
  tags: rancid

- name: Copy lg.conf
  template: src=lg.conf.j2
            dest=/etc/rancid/lg.conf
            owner=root
            group=rancid
            mode=0640
  tags: rancid

- name: Copy clogin
  template: src=cloginrc.j2
            dest={{ rancid_home }}/.cloginrc
            owner=root
            group=rancid
            mode=0640
  tags: rancid

- name: Copy postfix aliases
  template: src=aliases.j2
            dest=/etc/aliases
            owner=root
            group=root
            mode=0644
  tags: rancid

- name: Run rancid-cvs
  command: /usr/libexec/rancid/rancid-cvs
  sudo_user: rancid
  when: current_list_of_groups.stdout != "{{ rancid_list_of_groups }}"
  tags: rancid

- name: Configure router.db for groups
  lineinfile: dest={{ rancid_repo_dir }}/{{ item.group }}/router.db
              regexp='^{{ item.name }}'
              line='{{ item.name }}:{{ item.type }}:{{ item.state }}'
  sudo_user: rancid
  with_items: network_device
  tags: rancid
